Informe de mejoras de detección (squat / deadlift / bench)
========================================================

Resumen de cambios
------------------
1) Diagnóstico instrumentado
- Se añadió un bloque de diagnósticos serializable que incluye:
  * raw_scores, penalties, adjusted_scores y probabilities (softmax).
  * margin entre la mejor y la segunda hipótesis.
  * si se activó el tiebreak y la regla usada.
  * deadlift_veto con sus cues y un gate específico de barra alta / codos flexionados.
  * view_result con label, confidence, lateral_score, fiable_frames, reliability_ratio y dispersion.
- Estos diagnósticos se inyectan en RunStats (campo detection_diagnostics) y se propagan en el reporte, sin romper consumidores existentes.

2) Reducción de falsos “squat → deadlift”
- Se separaron los umbrales de knee_forward para evitar solape (zona de decisión más nítida).
- Se añadió un “gate” explícito: si la barra se ve alta y los codos están flexionados (configuración típica de sentadilla), se clampa el score ajustado de deadlift.
- Se ajustó la penalización de hinge en sentadilla para que la inclinación del torso no penalice por sí sola; ahora cuenta solo si hay evidencia de brazo/agarre de bisagra.

3) Tiebreak reequilibrado
- El desempate no favorece deadlift si hay evidencia mínima de sentadilla (profundidad + ROM de rodilla + barra alta/codos flexionados).
- Se mantiene el gate de bench como prioridad cuando su señal es fuerte.

4) Confianza menos “capada” por la vista
- La combinación final ya no usa min().
- Si la vista es “unknown” por baja fiabilidad, no se aplasta la confianza del ejercicio.
- Si la vista es conocida, se combina de forma suave: confidence_final = confidence_ejercicio * (0.6 + 0.4 * view_conf).

Justificación biomecánica y de robustez
---------------------------------------
- La sentadilla con barra alta suele implicar muñecas cerca del hombro y codos flexionados, señales incompatibles con un deadlift. Penalizar deadlift en estos casos reduce falsos positivos.
- El torso inclinado puede aparecer en sentadillas profundas; exigir además señales de bisagra (muñeca cerca de cadera o codos extendidos) evita penalizaciones erróneas.
- Separar los umbrales de knee_forward reduce la zona de ambigüedad entre patrones.
- La confianza debe reflejar separación real entre hipótesis; la vista es una señal auxiliar, por eso se combina suavemente y solo afecta cuando es confiable.

Riesgos / regresiones potenciales
---------------------------------
- El clamp de deadlift podría reducir sensibilidad en deadlifts con agarre muy alto o codos algo flexionados (casos atípicos o con tracking incompleto).
- La separación de knee_forward puede requerir ajuste fino si la normalización cambia con nuevas cámaras.
- El tiebreak puede favorecer sentadilla en clips con torso inclinado y poca visibilidad si aun así cumplen los criterios mínimos.

Cómo interpretar diagnostics
----------------------------
- raw_scores: suma de señales sin penalización.
- penalties: penalizaciones aplicadas (incluye clamp cuando se activa el gate de barra alta/codos flexionados).
- adjusted_scores: raw - penalties (y clamps) usados para decidir.
- probabilities: softmax de adjusted_scores, sirve como base de la confianza.
- margin: diferencia entre el mejor y el segundo; valores bajos indican ambigüedad.
- tiebreak: triggered + rule. Permite auditar cuándo se forzó una etiqueta.
- deadlift_veto: activo + cues. Señala si se aplicó veto de deadlift por evidencias fuertes.
- view_result: resumen de fiabilidad de la vista (lateral_score, reliable_frames, ratio, dispersion).

Cómo ajustar constantes a futuro
--------------------------------
- Para reducir más falsos deadlift: bajar DEADLIFT_SQUAT_BAR_CLAMP o subir SQUAT_WRIST_SHOULDER_DIFF_MAX_NORM / SQUAT_ELBOW_BOTTOM_MAX_DEG.
- Para mejorar separación por rodilla: ajustar SQUAT_KNEE_FORWARD_MIN_NORM y DEADLIFT_KNEE_FORWARD_MAX_NORM manteniendo un gap.
- Para suavizar el veto de deadlift: subir DEADLIFT_VETO_MOVEMENT_MIN o reducir pesos de señales de bisagra.
- Para confianza más/menos sensible a la vista: ajustar la mezcla (0.6 + 0.4 * view_conf).
